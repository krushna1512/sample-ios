api_key = app_store_connect_api_key(
  key_id: ENV['APP_STORE_CONNECT_API_KEY_KEY_ID'],
  issuer_id: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
  key_filepath: "~/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_KEY_ID']}.p8",
  in_house: false
)

lane :build_and_upload do
  match(
    type: "development",
    app_identifier: "com.yapsody.SampleApp",
    readonly: is_ci,
    keychain_name: ENV["MATCH_KEYCHAIN_NAME"],
    keychain_password: ENV["MATCH_KEYCHAIN_PASSWORD"],
    force_for_new_devices: true
  )

  gym(
    project: "SampleApp.xcodeproj",
    scheme: "SampleApp",
    clean: true,
    export_method: "development",
    export_options: {
      signingStyle: "manual",
      provisioningProfiles: {
        "com.yapsody.SampleApp" => "match Development com.yapsody.SampleApp"
      }
    },
    clean: true,
    output_directory: "./build"
  )

  deliver(
    ipa: "./build/SampleApp.ipa",
    skip_metadata: true,
    skip_screenshots: true,
    force: true,
    api_key: api_key
  )
end
